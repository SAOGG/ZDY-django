<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ blog.title }}</title>
</head>
<body>
    <h1>{{ blog.title }}</h1>
    <p>作者: {{ blog.author.username }} | 发布时间: {{ blog.created_at }}</p>
    <div>{{ blog.content }}</div>

    <hr>
    <h2>评论区</h2>

    {% if user.is_authenticated %}
    <form method="post">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit">提交评论</button>
    </form>
    {% else %}
    <p>请<a href="{% url 'login' %}?next={{ request.path }}">登录</a>后评论</p>
    {% endif %}

    <div class="comments">
        {% for comment in comments %}
        <div class="comment">
            <p>
                <strong>
                    {% if comment.author.profile.nickname %}
                        {{ comment.author.profile.nickname }}
                    {% else %}
                        {{ comment.author.username }}
                    {% endif %}
                </strong>
                {{ comment.created_at }}
            </p>
            <p>{{ comment.content }}</p>

            <!-- 回复按钮 -->
            {% if user.is_authenticated %}
            <button onclick="replyTo({{ comment.id }})">回复</button>
            {% endif %}

            <!-- 回复表单 -->
            <div id="reply-form-{{ comment.id }}" style="display: none; margin-left: 20px; margin-top: 10px;">
                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="parent_id" value="{{ comment.id }}">
                    <textarea name="content" rows="2" placeholder="回复 {{ comment.author.username }}..."></textarea>
                    <button type="submit">发送回复</button>
                </form>
            </div>

            <!-- 显示回复 -->
            {% if comment.replies.exists %}
            <div class="replies" style="margin-left: 40px; margin-top: 10px;">
                {% for reply in comment.replies.all %}
                <div class="reply">
                    <p>
                        <strong>
                            {% if reply.author.profile.nickname %}
                                {{ reply.author.profile.nickname }}
                            {% else %}
                                {{ reply.author.username }}
                            {% endif %}
                        </strong> 回复
                        <strong>
                            {% if reply.parent.author.profile.nickname %}
                                {{ reply.parent.author.profile.nickname }}
                            {% else %}
                                {{ reply.parent.author.username }}
                            {% endif %}
                        </strong>
                        {{ reply.created_at }}
                    </p>
                    <p>{{ reply.content }}</p>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        <hr>
        {% empty %}
        <p>暂无评论</p>
        {% endfor %}
    </div>

    <script>
        function replyTo(commentId) {
            // 隐藏所有回复表单
            document.querySelectorAll('[id^="reply-form-"]').forEach(el => {
                el.style.display = 'none';
            });
            // 显示当前回复表单
            document.getElementById(`reply-form-${commentId}`).style.display = 'block';
        }
    </script>

    <a href="{% url 'home' %}">返回主页</a>
</body>
</html>